[TOC]

# 缓存雪崩

## 为什么要有缓存
1. 提高性能: 缓存查询速度比数据库查询速度快(内存vs硬盘)
2. 提高并发能力: 缓存分担了部分请求，支持更高的并发

Redis不可能把所有的数据都缓存起来(内存昂贵且有限)，所以Redis需要对数据设置过期时间，并采用的是惰性删除+定期删除两种策略对过期键删除。Redis对过期键的策略+持久化

## 什么是缓存雪崩？
如果缓存数据**设置的过期时间是相同的**，并且Redis恰好将这部分数据全部删光了。这就会导致在这段时间内，这些缓存**同时失效**，全部请求到数据库中。
- redis挂掉了，全部请求走数据库。
- 对缓存数据设置相同的过期时间，导致某段时间内缓存失效，全部请求走数据库

## 如何解决缓存雪崩
对于“对缓存数据设置相同的过期时间，导致某段时间内缓存失效，请求全部走数据库。”这种情况，非常好解决：

- 解决方法：在缓存的时候给**过期时间加上一个随机值**，这样就会大幅度的减少缓存在同一时间过期。

对于“Redis挂掉了，请求全部走数据库”这种情况，我们可以有以下的思路：

- 事发前: 实现Redis的高可用(主从架构+Sentinel 或者Redis Cluster)，尽量避免Redis挂掉这种情况发生。
- 事发中: 万一Redis真的挂了，我们可以设置本地缓存(ehcache)+限流(hystrix)，尽量避免我们的数据库被干掉(起码能保证我们的服务还是能正常工作的)
- 事发后: redis持久化，重启后自动从磁盘上加载数据，快速恢复缓存数据。

# 缓存穿透

## 什么是缓存穿透
有一张数据库表，ID都是从1开始的(正数)：

但是可能有黑客想把数据库搞垮，每次请求的ID都是负数。这会导致缓存没用，请求全部都找数据库去了，但数据库也没有这个值啊，所以每次都返回空出去。

缓存穿透
**==是指查询一个一定不存在的数据。由于缓存不命中，并且出于容错考虑，如果从数据库查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到数据库去查询，失去了缓存的意义。==**

这就是缓存穿透：
请求的数据在缓存大量不命中，导致请求走数据库。
缓存穿透如果发生了，也可能把我们的数据库搞垮，导致整个服务瘫痪！

## 如何解决缓存穿透？

解决缓存穿透也有两种方案：

1. 由于请求的参数是不合法的(每次都请求不存在的参数)，于是我们可以使用布隆过滤器(BloomFilter)或者压缩filter提前拦截，不合法就不让这个请求到数据库层！
2. 当我们从数据库找不到的时候，我们也将这个空对象设置到缓存里边去。下次再请求的时候，就可以从缓存里边获取了。
这种情况我们一般会将空对象设置一个较短的过期时间。